<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Leslie & Rodger's Wedding</title>
    <style>
        main {
            text-align: center;
            max-width: 500px;
            margin: auto;
            font-family: Arial, sans-serif;
        }

        input,
        select,
        button {
            margin: 8px;
            padding: 8px;
            font-size: 16px;
        }

        form {
            margin-top: 20px;
        }

        #meal-options {
            margin-top: 10px;
        }
    </style>
</head>

<body>

    <!-- Dynamically loaded Header -->
    <div id="header-container"></div>

    <main>
        <h2>Welcome to Our Wedding!</h2>
        <p>Please RSVP below</p>

        <input type="text" id="first-name" placeholder="First Name" />
        <input type="text" id="last-name" placeholder="Last Name" />
        <br />
        <button onclick="checkRSVP()">Check RSVP</button>

        <div id="a1-value-container"></div>
    </main>

    <!-- Dynamically loaded Footer -->
    <div id="footer-container"></div>

    <script>
        // Function to load external HTML file into a container
        function loadHTML(containerId, fileName) {
            fetch(fileName)
                .then(response => response.text())
                .then(data => {
                    document.getElementById(containerId).innerHTML = data;
                })
                .catch(error => console.error('Error loading the file: ', error));
        }

        // Load the header and footer dynamically
        loadHTML("header-container", "/partials/header.html");
        loadHTML("footer-container", "/partials/footer.html");

        const allowedGuests = [
            { first: "Rodger", last: "Pang" },
            { first: "Leslie", last: "Wang" },
            { first: "Larry", last: "Wang" },
            { first: "Irene", last: "Cao" },
            { first: "James", last: "Pang" },
            { first: "Evelyn", last: "Pang" },
            { first: "Ryan", last: "Gittleson" },
            { first: "Jeffrey", last: "Wang" },
            { first: "Cassidy", last: "Chansirik" },
            { first: "Maya", last: "Cao" },
            { first: "Ed", last: "Liu" },

            { first: "Andrew", last: "Chan" },
            { first: "Kristen", last: "Lum" },
            { first: "Emmitt", last: "Burk" },
            { first: "Placeholder", last: "Placeholder" },
            { first: "Katherine", last: "Yang" },
            { first: "Kevin", last: "Wang" },
            { first: "Samuel", last: "Yauk" },
            { first: "Zumin", last: "Chen" },
            { first: "Cindy", last: "Chen" },
            { first: "Jonathan", last: "Yip" },

            // Add more guests here
        ];

        function checkRSVP() {
            const first = document.getElementById("first-name").value.trim();
            const last = document.getElementById("last-name").value.trim();

            const isAllowed = allowedGuests.some(
                g => g.first.toLowerCase() === first.toLowerCase() &&
                     g.last.toLowerCase() === last.toLowerCase()
            );

            if (!isAllowed) {
                alert("Sorry, you’re not on the guest list.");
                return;
            }

            fetchLatestRSVP(first, last);
        }

        function fetchLatestRSVP(firstName, lastName) {
            const sheetId = "121xHN9vq-vhGsXbGNFENLFtchdZs16gdAQ-azwo3vXE"; // your sheet ID
            const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tq=${encodeURIComponent("SELECT *")}`;

            fetch(url)
                .then(res => res.text())
                .then(data => {
                    const json = JSON.parse(data.substring(data.indexOf('{'), data.lastIndexOf('}') + 1));
                    const rows = json.table.rows;

                    if (!rows || rows.length === 0) {
                        showRSVPForm(firstName, lastName, null);
                        return;
                    }

                    const entries = rows.map(row => ({
                        timestamp: fixDate(row.c[0]?.f || row.c[0]?.v), // Timestamp from column 0
                        first: row.c[1]?.v || "",
                        last: row.c[2]?.v || "",
                        attending: row.c[3]?.v || "",
                        meal: row.c[4]?.v || ""
                    }));

                    // Filter all matching names (case-insensitive)
                    const matches = entries.filter(e =>
                        e.first.toLowerCase() === firstName.toLowerCase() &&
                        e.last.toLowerCase() === lastName.toLowerCase()
                    );

                    if (matches.length === 0) {
                        showRSVPForm(firstName, lastName, null);
                        return;
                    }

                    // Sort by timestamp (most recent first)
                    matches.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));

                    showRSVPForm(firstName, lastName, matches[0]); // use most recent
                })
                .catch(err => {
                    console.error("Error fetching RSVP data:", err);
                    alert("Could not check your RSVP status. Please try again later.");
                });
        }




        function fixDate(str) {
            if (!str) return null;
            const [date, time] = str.split(" ");
            const [month, day, year] = date.split("/");
            return `${year}-${month.padStart(2, '0')}-${day.padStart(2, '0')}T${time}`;
        }

        function showRSVPForm(first, last, existingData) {
            const container = document.getElementById("a1-value-container");
            let html = `<h3>Hello ${first} ${last}!</h3>`;

            if (existingData) {
                html += `
                    <p><strong>You’ve already RSVP'd:</strong></p>
                    <p>Coming: ${existingData.attending}</p>
                    <p>Meal: ${existingData.meal}</p>
                    <button onclick="renderForm('${first}', '${last}', true)">Edit</button>
                `;
            } else {
                html += `<button onclick="renderForm('${first}', '${last}', false)">RSVP Now</button>`;
            }

            container.innerHTML = html;
        }

        function renderForm(first, last, isEdit) {
            const container = document.getElementById("a1-value-container");
            container.innerHTML = `
                <form onsubmit="submitRSVP(event, '${first}', '${last}')">
                    <p>Are you coming?</p>
                    <select name="attending" required>
                        <option value="">Select...</option>
                        <option value="Yes">Yes</option>
                        <option value="No">No</option>
                    </select>

                    <div id="meal-options" style="display:block;">
                        <p>Meal choice:</p>
                        <select name="meal" required>
                            <option value="No Meal">No Meal</option>
                            <option value="Chicken">Chicken</option>
                            <option value="Shrimp">Shrimp</option>
                        </select>
                    </div>

                    <br />
                    <button type="submit">${isEdit ? "Update RSVP" : "Submit RSVP"}</button>
                </form>
            `;

            setTimeout(() => {
                document.querySelector("select[name='attending']").addEventListener("change", (e) => {
                    const mealOptions = document.getElementById("meal-options");
                    if (e.target.value === "No") {
                        mealOptions.style.display = "none"; // Hide the meal options
                        document.querySelector("select[name='meal']").value = "No Meal"; // Set default to No Meal
                    } else {
                        mealOptions.style.display = "block"; // Show the meal options
                    }
                });
            }, 100);
        }

        function submitRSVP(event, first, last) {
            event.preventDefault();

            const attending = document.querySelector("select[name='attending']").value;
            const meal = attending === "No"
                ? "No Meal"  // Ensure "No Meal" is selected when attending is "No"
                : document.querySelector("select[name='meal']").value || "No Meal";  // Default meal if no option is selected

            const formUrl = "https://docs.google.com/forms/d/1Mo1nlXK0j6Pwny9U6wlKrVv3kmHnkfwS_SmEJz3qVbs/formResponse"; // replace with your actual form URL
            const formData = new FormData();

            formData.append("entry.841300474", first);
            formData.append("entry.1186545421", last);
            formData.append("entry.1977640725", attending);
            formData.append("entry.136353009", meal);  // Ensure meal is always set

            fetch(formUrl, {
                method: "POST",
                mode: "no-cors",
                body: formData
            }).then(() => {
                document.getElementById("a1-value-container").innerHTML = `
                    <p>Thank you! Your RSVP has been submitted.</p>
                `;
            }).catch(() => {
                document.getElementById("a1-value-container").innerHTML = `
                    <p>There was an error submitting your RSVP. Please try again.</p>
                `;
            });
        }

    </script>
</body>

</html>
